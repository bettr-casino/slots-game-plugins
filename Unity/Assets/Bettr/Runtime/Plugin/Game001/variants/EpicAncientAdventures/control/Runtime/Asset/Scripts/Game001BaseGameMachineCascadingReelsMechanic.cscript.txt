require "math"
require "Core"

Game001BaseGameMachineCascadingReelsMechanic = {
}

function Game001BaseGameMachineCascadingReelsMechanic:new(o)
	o = o or {}
	setmetatable(o, self)
	self.__index = self
	return o
end

function Game001BaseGameMachineCascadingReelsMechanic:OnError(callStack)
	System.Error("BaseGameMachineCascadingReelsMechanic Error CallStack: {0}", callStack)
end

function Game001BaseGameMachineCascadingReelsMechanic:Initialize(machine)
end

function Game001BaseGameMachineCascadingReelsMechanic:TryPaying(machine)
end

function Game001BaseGameMachineCascadingReelsMechanic:BaseGamePayout(machine)
    series
        do
            machine:OnPayingCompleted()
        end
    end
end

function Game001BaseGameMachineCascadingReelsMechanic:OnPayingCompleted(machine)
    BettrAudioController.StopAudio()
    BettrUserController.DisableUserInSlamStopMode()
    machine:RollupCredits()
end

function Game001BaseGameMachineCascadingReelsMechanic:OnBaseGameSpinCompleted(machine)
    series
        do
            Game001BaseGameState.SpinState.First.State = "Completed"
            Game001BaseGameState.DisplayState.First.State = "Idle" 
        end
    end
end

function Game001BaseGameMachineCascadingReelsMechanic:RollupCredits(machine)
    local oldCoins = BettrUser.Coins
    local newCoins = BettrUser.SpinCoins
    BettrUser.ApplySpinCoins()
    local pays = newCoins - oldCoins
    System.StartCoroutine(self, "OnRollupCredits", machine, oldCoins, newCoins, pays)
end

function Game001BaseGameMachineCascadingReelsMechanic:OnRollupCredits(machine, oldCoins, newCoins, pays)
    series
        do
            local winTextProperty = machine.WinText            
            if pays > 0 then
                BettrAudioController.PlayAudioLoop("rollupwins")            
                BettrVisualsController.RollUpCounter(winTextProperty, 0, pays, 0.3)
                System.WaitForSeconds(0.3)
                BettrAudioController.StopAudio()
            end
        end
        do
            local creditsTextProperty = machine.CreditsText   
            if pays ~= 0 then
                if pays > 0 then
                    BettrAudioController.PlayAudioLoop("rollupcoins")            
                end
                BettrVisualsController.RollUpCounter(creditsTextProperty, oldCoins, newCoins, 1)
                System.WaitForSeconds(1)
                BettrAudioController.StopAudio()
            end
        end
        do
            self:StartCascade(machine)
        end
    end
end

function Game001BaseGameMachineCascadingReelsMechanic:StartCascade(machine)
    series
        do                
            local cascadeCount = Game001BaseGameCascadingReelsSummary.CascadingReels.First.CascadeCount
            local cascades = Game001BaseGameCascadingReelsCascades.CascadingReels.Array
            local cascadesMatrix = Game001BaseGameCascadingReelsCascadesMatrix
            for counterIndex = 1, cascadeCount series do
                local cascade = cascades[counterIndex]
                local cascadeID = cascade.Cascade
                local cascadeAction = cascade.Action
                System.Print("cascadeID={0} counterIndex={1} cascadeAction={2}", cascadeID, counterIndex, cascadeAction)                                    
                local cascadeMatrix = cascadesMatrix[cascadeID].Array
                local cascadeMatrixCount = cascadesMatrix[cascadeID].Count
                self:SymbolRemovalActions(cascadeMatrix, cascadeMatrixCount, cascadeAction)
            end                        
        end
        do
            machine:OnBaseGameSpinCompleted()
        end
    end
end

function Game001BaseGameMachineCascadingReelsMechanic:SymbolRemovalActions(cascadeMatrix, cascadeMatrixCount, cascadeAction)
    for matrixIndex = 1, cascadeMatrixCount parallel do
        local cascadeMatrixRow = cascadeMatrix[matrixIndex]
        local cascadeReelID = cascadeMatrixRow.ReelID
        local cascadeRowIndex = cascadeMatrixRow.RowIndex 
        System.Print("cascadeReelID={0} cascadeRowIndex={1} cascadeAction={2}", cascadeReelID, cascadeRowIndex, cascadeAction)                    
        if cascadeAction == "SymbolRemoval" then
            self:SymbolRemovalAction(cascadeReelID, cascadeRowIndex)
        end
    end
end

function Game001BaseGameMachineCascadingReelsMechanic:SymbolRemovalAction(reelID, rowIndex)
    series
        do
            local reel = _G["Game001BaseGame" .. reelID]
            local luaRowIndex = rowIndex + 1
            local symbolGroupProperty = reel["SymbolGroup" .. luaRowIndex]
            symbolGroupProperty.SetAllInactive()
            System.WaitForSeconds(1.0)
        end
    end
end



