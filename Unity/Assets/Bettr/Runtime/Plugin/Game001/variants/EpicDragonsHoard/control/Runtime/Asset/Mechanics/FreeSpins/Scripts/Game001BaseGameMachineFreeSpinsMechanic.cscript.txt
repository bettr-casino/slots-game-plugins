require "math"
require "Core"

Game001BaseGameMachineFreeSpinsMechanic = {
    Config = {
        Machine = "Game001",
        Variant = "EpicDragonsHoard",
        Experiment = "control",
        Mechanic = "FreeSpins",
    },
    State = {
        MechanicsPrefab = nil,
        ReelMatrixMechanic = nil,
    }
}

function Game001BaseGameMachineFreeSpinsMechanic:new(o)
	o = o or {}
	setmetatable(o, self)
	self.__index = self
	return o
end

function Game001BaseGameMachineFreeSpinsMechanic:Initialize(machine)
    series
        do
            local manifest = Game001.Manifest
            local prefabName = "BaseGameMachineFreeSpins"
            local machineParent = machine.MachineParent
            local mechanicsParent = machine.MechanicsParent
            local mechanicsPrefab = BettrAssetController.LoadPrefab(manifest.BundleName, manifest.BundleVersion, prefabName, mechanicsParent.GameObject)
            mechanicsPrefab.SetActive(false)
            mechanicsPrefab.name = self.Config.Mechanic
            self.State.MechanicsPrefab = mechanicsPrefab
            self.State.ReelMatrixMechanic = machine.Mechanics.ReelMatrixMechanic
        end
    end
end

function Game001BaseGameMachineFreeSpinsMechanic:OnBaseGameSpinCompleted(machine)
    series
        do
            System.Print("Game001BaseGameMachineFreeSpinsMechanic:Game001BaseGameState.SpinState.First.State={0}", Game001BaseGameState.SpinState.First.State)
            Game001BaseGameState.SpinState.First.State = "Waiting"
            System.WaitForSeconds(1)
            local machineParent = machine.MachineParent
            local mechanicsPrefab = self.State.MechanicsPrefab
            local reelStripData = BettrMathController.GetBaseGameMechanicDataMatrix(self.Config.Machine, self.Config.Mechanic, "ReelStrip")
            
            machineParent.SetActive(false)            
            
            local outcomesTable = BettrMathController.GetBaseGameMechanicMatrix(self.Config.Machine, self.Config.Mechanic, "Outcomes")
            
            self.State.ReelMatrixMechanic:SetReelStripData(reelStripData)
            self.State.ReelMatrixMechanic:SetReelStripSymbolTextures(self.State.MechanicsPrefab)
            self.State.ReelMatrixMechanic:SetOutcomes(outcomesTable)
            self.State.ReelMatrixMechanic:ShowReelMatrix()            
            self.State.ReelMatrixMechanic:StartEngines()
            
            self:SpinEngines(machine)
            
            System.WaitForSeconds(3)
            
            self:SpinEngines(machine)
        end
    end
end

function Game001BaseGameMachineFreeSpinsMechanic:SpinEngines(machine)
    self.State.ReelMatrixMechanic:SpinEngines(self, machine)
end


